{% extends "base.html" %}
{% block title %}Watchlist{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-bookmark-star me-2"></i>Watchlist</h4>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" id="batch-btn" onclick="startBatchAnalysis()">
            <i class="bi bi-play-circle me-1"></i>Analyze All
        </button>
    </div>
</div>

<!-- Add Stock -->
<div class="card bg-dark border-secondary mb-3">
    <div class="card-body">
        <form id="add-form" class="d-flex gap-2">
            <input type="text" id="add-symbol" class="form-control" placeholder="Add stock (e.g. RELIANCE.NS)" autocomplete="off">
            <button type="submit" class="btn btn-success text-nowrap"><i class="bi bi-plus-lg"></i> Add</button>
        </form>
    </div>
</div>

<!-- Batch Progress -->
<div id="batch-progress" class="d-none mb-3">
    <div class="card bg-dark border-primary">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <span id="batch-text">Running batch analysis...</span>
                <span id="batch-counter">0/0</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div id="batch-bar" class="progress-bar bg-primary" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Table -->
<div class="card bg-dark border-secondary">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Symbol</th>
                        <th class="text-end">LTP</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="watchlist-body">
                    <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Batch Results -->
<div id="batch-results" class="d-none mt-3">
    <h5><i class="bi bi-clipboard-data me-2"></i>Batch Analysis Results</h5>
    <div class="table-responsive">
        <table class="table table-dark table-hover table-sm">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Price</th>
                    <th>Fund</th>
                    <th>Valuation</th>
                    <th>Tech</th>
                    <th>Verdict</th>
                    <th>Confidence</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="batch-results-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let watchlistStocks = [];

document.addEventListener('DOMContentLoaded', loadWatchlist);

async function loadWatchlist() {
    const d = await apiCall('/api/watchlist');
    if (!d) return;
    watchlistStocks = d.stocks;
    const body = document.getElementById('watchlist-body');
    if (!d.stocks.length) {
        body.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Watchlist empty. Add stocks above.</td></tr>';
        return;
    }
    body.innerHTML = d.stocks.map((s, i) => `
        <tr>
            <td class="text-muted">${i + 1}</td>
            <td><a href="/analyze?symbol=${encodeURIComponent(s)}" class="text-light text-decoration-none fw-bold">${s}</a></td>
            <td class="text-end" id="ltp-${s.replace('.', '_')}">--</td>
            <td class="text-center">
                <a href="/analyze?symbol=${encodeURIComponent(s)}" class="btn btn-sm btn-outline-primary me-1" title="Analyze"><i class="bi bi-search"></i></a>
                <button class="btn btn-sm btn-outline-danger" onclick="removeStock('${s}')" title="Remove"><i class="bi bi-trash"></i></button>
            </td>
        </tr>`).join('');
    // Fetch LTP for first 20
    const batch = d.stocks.slice(0, 20);
    const prices = await apiCall(`/api/ltp?symbols=${batch.join(',')}`);
    if (prices) {
        for (const [sym, price] of Object.entries(prices)) {
            const el = document.getElementById('ltp-' + sym.replace('.', '_'));
            if (el) el.textContent = '₹' + price.toFixed(2);
        }
    }
}

document.getElementById('add-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const sym = document.getElementById('add-symbol').value.trim().toUpperCase();
    if (!sym) return;
    const d = await apiCall('/api/watchlist', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbol: sym})
    });
    if (d) {
        document.getElementById('add-symbol').value = '';
        loadWatchlist();
    }
});

async function removeStock(symbol) {
    if (!confirm(`Remove ${symbol}?`)) return;
    await apiCall(`/api/watchlist/${encodeURIComponent(symbol)}`, {method: 'DELETE'});
    loadWatchlist();
}

async function startBatchAnalysis() {
    const btn = document.getElementById('batch-btn');
    btn.disabled = true;
    show('batch-progress');
    hide('batch-results');

    const d = await apiCall('/api/analyze/batch', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbols: watchlistStocks})
    });
    if (!d || !d.task_id) { btn.disabled = false; hide('batch-progress'); return; }

    const poll = async () => {
        const data = await apiCall(`/api/analyze/batch/${d.task_id}`);
        if (!data) { btn.disabled = false; hide('batch-progress'); return; }

        const pct = data.total > 0 ? Math.round(data.completed / data.total * 100) : 0;
        document.getElementById('batch-bar').style.width = pct + '%';
        document.getElementById('batch-counter').textContent = `${data.completed}/${data.total}`;
        document.getElementById('batch-text').textContent = `Analyzing ${data.current || ''}...`;

        if (data.results && data.results.length > 0) {
            renderBatchResults(data.results);
            show('batch-results');
        }

        if (data.status === 'running') {
            setTimeout(poll, 3000);
        } else {
            btn.disabled = false;
            document.getElementById('batch-text').textContent = 'Analysis complete!';
        }
    };
    poll();
}

function renderBatchResults(results) {
    const body = document.getElementById('batch-results-body');
    body.innerHTML = results.map(r => {
        const v = r.verdict || {};
        const f = r.fundamentals || {};
        const fr = r.fund_result || {};
        const vr = r.val_result || {};
        const cl = r.checklist_result || {};
        const ma = r.moving_averages || {};
        return `<tr>
            <td><a href="/analyze?symbol=${r.symbol}" class="text-light">${r.symbol}</a></td>
            <td>₹${ma.current_price || '--'}</td>
            <td>${fr.score || 0}/${fr.assessed || 0}</td>
            <td><span class="badge ${valColor(vr.verdict)}">${vr.verdict || 'N/A'}</span></td>
            <td>${cl.score || 0}/7</td>
            <td><span class="badge ${verdictColor(v.verdict)}">${v.verdict || '--'}</span></td>
            <td>${v.confidence || '--'}</td>
            <td><a href="/analyze?symbol=${r.symbol}" class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a></td>
        </tr>`;
    }).join('');
}
</script>
{% endblock %}
