{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-gear me-2"></i>Settings</h4>

<div class="row g-3">
    <!-- Kite Connect -->
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Zerodha Kite Connect</span>
                <span id="kite-conn-status" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <form id="kite-form">
                    <div class="mb-3">
                        <label class="form-label">API Key</label>
                        <input type="text" id="kite-api-key" class="form-control bg-dark text-light" placeholder="Your Kite API Key">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API Secret</label>
                        <input type="password" id="kite-api-secret" class="form-control bg-dark text-light" placeholder="Your Kite API Secret">
                    </div>
                    <button type="submit" class="btn btn-primary me-2"><i class="bi bi-save me-1"></i>Save Credentials</button>
                    <button type="button" class="btn btn-success" id="kite-login-btn" onclick="kiteLogin()"><i class="bi bi-box-arrow-in-right me-1"></i>Connect to Zerodha</button>
                </form>
                <div class="mt-3">
                    <small class="text-muted">
                        Get API credentials from <a href="https://developers.kite.trade/" target="_blank" class="text-info">developers.kite.trade</a><br>
                        Set redirect URL to: <code>http://127.0.0.1:5000/api/kite/callback</code>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Config -->
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header">Email Configuration</div>
            <div class="card-body">
                <div id="email-config-display"></div>
                <small class="text-muted">
                    Email config is managed via <code>email_config.json</code>.<br>
                    Run <code>python email_scheduler.py</code> to configure interactively.
                </small>
            </div>
        </div>
    </div>

    <!-- App Info -->
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header">Application Info</div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-0">
                    <tr><td>Watchlist Path</td><td><code>watchlist.txt</code></td></tr>
                    <tr><td>Results Directory</td><td><code>analysis_results/</code></td></tr>
                    <tr><td>Data Sources</td><td>Screener.in + yfinance</td></tr>
                    <tr><td>Framework</td><td>3-Gate: Fundamental + Valuation + Technical</td></tr>
                    <tr><td>Profile</td><td>Positional (1-6 months) | Moderate Risk</td></tr>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const d = await apiCall('/api/kite/status');
    if (d) {
        const badge = document.getElementById('kite-conn-status');
        if (d.connected) {
            badge.textContent = 'Connected';
            badge.className = 'badge bg-success';
        } else if (d.configured) {
            badge.textContent = 'Disconnected';
            badge.className = 'badge bg-warning';
        } else {
            badge.textContent = 'Not Configured';
            badge.className = 'badge bg-secondary';
        }
    }

    // Check URL params for errors
    const params = new URLSearchParams(window.location.search);
    if (params.get('error')) {
        showError('Kite auth failed: ' + params.get('error'));
    }
});

document.getElementById('kite-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const apiKey = document.getElementById('kite-api-key').value.trim();
    const apiSecret = document.getElementById('kite-api-secret').value.trim();
    if (!apiKey || !apiSecret) { showError('Both fields required'); return; }

    const d = await apiCall('/api/settings/kite', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({api_key: apiKey, api_secret: apiSecret})
    });
    if (d) {
        document.getElementById('kite-conn-status').textContent = 'Saved';
        document.getElementById('kite-conn-status').className = 'badge bg-info';
    }
});

async function kiteLogin() {
    const d = await apiCall('/api/kite/login');
    if (d && d.login_url) {
        window.location.href = d.login_url;
    }
}
</script>
{% endblock %}
