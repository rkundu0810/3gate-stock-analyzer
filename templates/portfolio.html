{% extends "base.html" %}
{% block title %}Portfolio{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-wallet2 me-2"></i>Portfolio</h4>

<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#paper-tab">Paper Portfolio</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#zerodha-tab">Zerodha Holdings</button>
    </li>
</ul>

<div class="tab-content">
    <!-- Paper Portfolio -->
    <div class="tab-pane fade show active" id="paper-tab">
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Capital</h6>
                        <h4 id="paper-capital">--</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Invested</h6>
                        <h4 id="paper-invested">--</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Positions</h6>
                        <h4 id="paper-positions-count">--</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="card bg-dark border-secondary">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Avg Price</th>
                                <th class="text-end">LTP</th>
                                <th class="text-end">P&L</th>
                                <th class="text-end">P&L %</th>
                            </tr>
                        </thead>
                        <tbody id="paper-body">
                            <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Zerodha Holdings -->
    <div class="tab-pane fade" id="zerodha-tab">
        <div id="zerodha-not-connected" class="text-center py-5">
            <i class="bi bi-plug fs-1 text-muted"></i>
            <h5 class="mt-3">Zerodha Not Connected</h5>
            <p class="text-muted">Connect your Zerodha account in Settings to view live holdings.</p>
            <a href="/settings" class="btn btn-primary"><i class="bi bi-gear me-1"></i>Go to Settings</a>
        </div>
        <div id="zerodha-connected" class="d-none">
            <div class="card bg-dark border-secondary">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th class="text-end">Qty</th>
                                    <th class="text-end">Avg Price</th>
                                    <th class="text-end">LTP</th>
                                    <th class="text-end">P&L</th>
                                    <th class="text-end">P&L %</th>
                                </tr>
                            </thead>
                            <tbody id="zerodha-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Paper portfolio
    const p = await apiCall('/api/portfolio/paper');
    if (p) {
        document.getElementById('paper-capital').textContent = formatINR(p.capital || 500000);
        document.getElementById('paper-invested').textContent = formatINR(p.invested || 0);
        const positions = p.positions || {};
        const symbols = Object.keys(positions);
        document.getElementById('paper-positions-count').textContent = symbols.length;

        if (symbols.length === 0) {
            document.getElementById('paper-body').innerHTML = '<tr><td colspan="6" class="text-center text-muted">No paper positions yet</td></tr>';
        } else {
            // Fetch LTP for all positions
            const prices = await apiCall(`/api/ltp?symbols=${symbols.join(',')}`);
            const body = document.getElementById('paper-body');
            body.innerHTML = symbols.map(sym => {
                const pos = positions[sym];
                const qty = pos.quantity || pos.qty || 0;
                const avg = pos.avg_price || pos.average_price || 0;
                const ltp = (prices && prices[sym]) || 0;
                const pnl = (ltp - avg) * qty;
                const pnlPct = avg > 0 ? ((ltp - avg) / avg * 100) : 0;
                const color = pnl >= 0 ? 'text-success' : 'text-danger';
                return `<tr>
                    <td><a href="/analyze?symbol=${sym}" class="text-light">${sym}</a></td>
                    <td class="text-end">${qty}</td>
                    <td class="text-end">${formatINR(avg)}</td>
                    <td class="text-end">${ltp ? formatINR(ltp) : '--'}</td>
                    <td class="text-end ${color}">${ltp ? formatINR(pnl) : '--'}</td>
                    <td class="text-end ${color}">${ltp ? pnlPct.toFixed(1) + '%' : '--'}</td>
                </tr>`;
            }).join('');
        }
    }

    // Zerodha
    const kite = await apiCall('/api/kite/status');
    if (kite && kite.connected) {
        hide('zerodha-not-connected');
        show('zerodha-connected');
        const zd = await apiCall('/api/portfolio/zerodha');
        if (zd && zd.holdings) {
            const body = document.getElementById('zerodha-body');
            body.innerHTML = zd.holdings.map(h => {
                const pnl = h.pnl || ((h.last_price - h.average_price) * h.quantity);
                const pnlPct = h.average_price > 0 ? ((h.last_price - h.average_price) / h.average_price * 100) : 0;
                const color = pnl >= 0 ? 'text-success' : 'text-danger';
                return `<tr>
                    <td>${h.tradingsymbol}</td>
                    <td class="text-end">${h.quantity}</td>
                    <td class="text-end">${formatINR(h.average_price)}</td>
                    <td class="text-end">${formatINR(h.last_price)}</td>
                    <td class="text-end ${color}">${formatINR(pnl)}</td>
                    <td class="text-end ${color}">${pnlPct.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }
    }
});
</script>
{% endblock %}
